# Retornos dos ativos elegíveis nos últimos meses

Nesse ponto temos o código de cada fundo elegível para compor nosso portfólio em cada mês. Agora, calculamos o retorno acumulado de cada fundo elegível em cada mês para diferentes períodos de estimação (1:12).

```{r}
# Garantimos que nossos dados de cota nao possuem NAs. Isso sera importante para calculo do retorno acumulado
cota_diario <- cota_diario %>% dplyr::select(Data, all_of(unique(do.call('c', lista_fundos_eleg))))
cota_diario_xts <- xts(cota_diario[,-1], cota_diario$Data)
cota_diario_xts <- na.locf(cota_diario_xts)
cota_diario <- data.frame(Data = index(cota_diario_xts), cota_diario_xts) %>% set_names(colnames(cota_diario))

rm(cota_diario_xts)
```


```{r}
lista_ret_ativos_eleg <- list()
for (i in seq_along(lista_fundos_eleg)) {
  # Extraimos o periodo final de estimacao da nossa lista de fundos elegiveis
  fim_estim <- as.Date(names(lista_fundos_eleg)[i])
  
  # Extraimos os fundos elegiveis naquele mes
  fundos_eleg <- lista_fundos_eleg[[i]]
  
  ret_acumul_period <- list()
  # Calculamos o retorno acumulado dos fundos presentes na lista acima para os 1:12 meses anteriores ao periodo final de estimacao.
  for (j in 1:12) {
    inicio_estim <- fim_estim %m-% months(j)
    
    # Selecionamos os fundos elegiveis e o periodo estabelecido
    cota_periodo <- cota_diario %>% dplyr::filter(Data > inicio_estim & Data <= fim_estim) %>% dplyr::select(all_of(fundos_eleg))
    
    # Selecionamos o periodo estabelecido para o risk free e indice de mercado
    ind_rf_periodo <- ind_rf %>% dplyr::filter(Data > inicio_estim & Data <= fim_estim) %>% dplyr::select(!Data)
    
    # Calculamos o retorno acumulado do indice de mercado e do risk free
    ind_rf_acaumul_interv <- apply(ind_rf_periodo, 2, function(x) prod(1 + x) - 1)
    
    # Retorno = Preco Final / Preco Inicial - 1
    ret_acumul_interv <- apply(cota_periodo, 2, function(x) x[length(x)] / x[1] - 1)
    
    # Df com o codigo de cada fundo, retorno acumulado e o retorno acumulado em excesso a taxa livre de risco e em excesso ao indice de mercado
    ret_acumul_period[[j]] <- data.frame(names(ret_acumul_interv), ret_acumul_interv, ret_acumul_interv - ind_rf_acaumul_interv[1], ret_acumul_interv - ind_rf_acaumul_interv[2]) %>% set_names('codigo', paste0('ret_last', j), paste0('ret_last', j, '_ind'), paste0('ret_last', j, '_rf'))
    
  }
  
  # Juntamos todas as dfs presentes na lista em uma df unica
  lista_ret_ativos_eleg[[i]] <- Reduce(function(x, y) merge(x, y, by="codigo"), ret_acumul_period)
  
}

names(lista_ret_ativos_eleg) <- names(lista_fundos_eleg)

rm(cota_periodo, ret_acumul_interv, ret_acumul_period, fundos_eleg, fim_estim, inicio_estim, i, j)
```

# Captação líquida, resgate, captação e número de cotistas nos meses seguintes

Importamos os dados mensais para facilitar a construção dessa parte

```{r}
dados_mensais <- readRDS('dados_tratados_mes.rds')
```

Criamos uma função para iterar sobre as colunas de indicadores de cada fundo. A inteção é passar tudo para uma única coluna.

```{r}
reshape_data <- function(j){
    fundo <- fundos_eleg[j]
    
    # Filtramos a base mensal para termos apenas o dado daquele fundo naquele mes
    fundo_mes <- dados_mensais %>% dplyr::filter(Fundo == fundo & Data >= inicio_aval & Data <= fim_aval)
    
    indic_fundo <- vector('list', length = (ncol(fundo_mes)-2))
    # Para cada indicador...
    for (k in 1:(ncol(fundo_mes)-2)) {
      indic <- as.data.frame(t(fundo_mes[, k+2, drop = FALSE]))
      
      colnames(indic) <- paste(rownames(indic), 0:12, sep = '_')
      
      rownames(indic) <- fundo
      
      indic_fundo[[k]] <- indic
    }
    
    dados_fundo_mes <- do.call('cbind', indic_fundo)
    
    return(dados_fundo_mes)
}
```

```{r}
dados_pos_ativos_elg <- vector('list', length = length(lista_ret_ativos_eleg))
# Para cada mes...
for (i in seq_along(lista_ret_ativos_eleg)) {
  print(paste('Mes', i, 'em', length(lista_ret_ativos_eleg), 'meses', sep = ' '))
  
  # Nesse ponto, o que era o fim do periodo de estimacao passa a ser o inicio do periodo de avaliacao
  inicio_aval <- as.Date(names(lista_ret_ativos_eleg)[i])
  
  fim_aval <- inicio_aval %m+% months(12)
  fim_aval <- ceiling_date(fim_aval, 'months') - 1
  
  # Extraimos os fundos elegiveis naquele mes
  fundos_eleg <- lista_ret_ativos_eleg[[i]]$codigo
  
  dados_fundo_mes <- future_map(1:length(fundos_eleg), reshape_data)
  
  dados_pos_ativos_elg[[i]] <- do.call('rbind', dados_fundo_mes)
}

names(dados_pos_ativos_elg) <- names(lista_ret_ativos_eleg)
```