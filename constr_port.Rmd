---
title: "Portfólio de Fundos"
output: html_notebook
---

# Pacotes

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(reticulate)
library(tidyverse)
library(xts)
library(PerformanceAnalytics)
library(lubridate)
library(janitor)
library(furrr)

# Prepare for parallel processing
plan(multisession, workers = parallel::detectCores())
```

# Dados Índice e Risk Free

```{r}
ind_rf <- read.csv('ind_rf.csv')
ind_rf$Data <- as.Date(ind_rf$Data)
```


# Dados Fundos

Importamos os dados diários referentes aos fundos e, também, os dados cadastrais.

```{r}
dados_diarios <- readRDS('dados_tratados_diarios.rds')
names(dados_diarios) <- c('capt_liq', 'capt', 'cota', 'n_cotistas', 'patrim_liq', 'resg', 'tx_adm')

dados_cadast <- readRDS('dados_cadastrais.rds')
```

# Ativos elegíveis

Partimos agora para a construção dos fundos elegíveis a fazerem parte do portfólio. Aplicaremos as seguintes restrições a cada mês:

* Fundo precisa existir a, no mínimo, 12 meses;
* Nesses 12 últimos meses o fundo precisa ter dado de cota em pelo menos 80% dos dias em que o mercado esteve aberto;
* O fundo precisa ter um patrimônio líquido maior que R$5.000.000,00. Fazemos isso para evitar o viés da incubação.
* O fundo não pode ser exclusivo

```{r}
# Garantimos que as datas dos dados de cota sao as mesmas que as datas do indice de mercado
cota_diario <- merge(ind_rf[, 1, drop = FALSE], dados_diarios[['cota']], all.x = TRUE)
```

```{r}
# Definimos o numero de meses existente entre as duas datas do nosso trabalho
n_meses <- interval(ymd(20091231), ymd(20201231)) %/% months(1) + 1

# Criamos uma lista vazia para guardar os fundos elegiveis em cada mes
lista_fundos_eleg <- list()
# Look back in months
look_back <- 12
for (i in 1:n_meses) {
  # Periodo para determinacao dos ativos elegiveis com base em uma janela movel de 12 meses
  fim_estim <- ymd(20091231) %m+% months(i-1)
  inicio_estim <- fim_estim %m-% months(look_back)
  inicio_estim <- ceiling_date(inicio_estim, 'months') - 1
  
  # Selecionamos os fundos que ja existiam no inicio do periodo de estimacao e que nao deixaram de existir apos o fim do periodo de estimacao
  fundos_existe <- dados_cadast %>% dplyr::filter(data_inicio <= inicio_estim & (data_fim > fim_estim | is.na(data_fim))) %>% dplyr::select(codigo, data_inicio, data_fim)
  
  # Definimos uma variavel com o codigo dos fundos que existiam ante do inicio_estim
  fundos_eleg <- fundos_existe$codigo
  
  # Filtramos a base de dados de cota para termos apenas o periodo de 12 meses
  ## Garantimos que nao temos NA (fundo existia antes do look_back e ate o fim_estim)
  ## E que o fundo e liquido o suficiente
  cota_periodo <- cota_diario %>% dplyr::filter(Data > inicio_estim & Data <= fim_estim) %>%
    dplyr::select(all_of(fundos_eleg)) %>% 
    dplyr::select_if(~ !any(is.na(.))) %>%
    dplyr::select_if(function(x) sum(x != 0) %ni% 0:(look_back*21*0.20))
  
  fundos_eleg <- colnames(cota_periodo)[-1]
  
  # Verificamos se esses fundos possuem um PL medio no ultimo mes maior que 5MM (restricao 3)
  
  ## Para isso, primeiro alteramos o inicio da estimacao
  inicio_estim <- fim_estim %m-% months(1)
  
  ## Agora, filtramos a base de dados com os dados de PL para essas datas e para os fundos que atenderam o criterio 1 e 2
  pl_periodo <- dados_diarios[['patrim_liq']] %>% dplyr::filter(Data > inicio_estim & Data <= fim_estim) %>% dplyr::select(all_of(fundos_eleg))
  
  ## Calculamos o PL medio de cada fundo. Lembrando que os dados estao em milhares.
  media_pl <- apply(pl_periodo, 2, function(pl_fundo) mean(pl_fundo, na.rm = TRUE))
  
  ## Atualizamos os fundos elegiveis para aqueles que atendem, tambem, a restricao 3
  fundos_eleg <- names(media_pl[media_pl >= 5000])
  
  # Verificamos se os fundos elegiveis ate o momento (fundos_eleg) sao exclusivos ou nao
  dados_exclusiv <- dados_cadast %>% dplyr::filter(codigo %in% fundos_eleg & fundo_exclusivo == 'Não') %>% dplyr::select(codigo, fundo_exclusivo)
  
  lista_fundos_eleg[[as.character(fim_estim)]] <- dados_exclusiv$codigo
}

rm(cota_periodo, dados_exclusiv, fundos_existe, pl_periodo, fim_estim, fundos_eleg, i, inicio_estim, media_pl, n_meses, prop_na)
```

# Construção Portfólio

## Definição dos ativos em cada portfólio

```{r}
lista_ativos_ports <- vector('list', length = length(lista_fundos_eleg))
for (i in seq_along(lista_fundos_eleg)) {
  fim_estim <- as.Date(names(lista_fundos_eleg)[i])
  inicio_estim <- fim_estim %m-% months(12)
  inicio_estim <- ceiling_date(inicio_estim, 'months') - 1
  
  # Selecionamos a cota para o periodo de estimacao
  cota_periodo <- cota_diario %>%
    dplyr::filter(Data > inicio_estim & Data <= fim_estim) %>%
    dplyr::select(all_of(lista_fundos_eleg[[i]]))
  
  # Calculamos o retorno no periodo selecionando a primeira e ultima observacao nao NA
  ret_acumul <- as.data.frame(apply(cota_periodo, 2, function(cota) cota[!is.na(cota)][length(cota[!is.na(cota)])] / cota[!is.na(cota)][1] - 1)) %>% set_names('ret_acumul') %>% arrange(desc(ret_acumul))
  
  # Break points portfolios
  x <- 1:nrow(ret_acumul)
  split_seq <- split(x, cut(x, 10, labels = FALSE))
  
  # Lista ativos em cada portfolio
  lista_ativos_ports[[i]] <- lapply(split_seq, function(x) ret_acumul[x, , drop = FALSE])
}

names(lista_ativos_ports) <- names(lista_fundos_eleg)
```

## Retorno de cada portfólio

```{r}
# A cada quantos meses devemos rebalancear o portfólio?
rebalance_freq <- 12

# Definimos o numero de rebalanceamentos
n_meses <- interval(ymd(20091231), ymd(20201231)) %/% months(rebalance_freq) + 1

for (i in 1:n_meses) {
  inicio_aval <- as.Date(names(lista_ativos_ports)[1 + (i - 1)*12])
  fim_aval <- inicio_aval %m+% months(rebalance_freq)
  fim_aval <- ceiling_date(fim_aval, 'month') - 1
  
  # Selecionamos os ativos de determinado portfolio
  ativos_port_mes <- rownames(lista_ativos_ports[[i]][[1]])

  # Selecionamos a cota para o periodo de avaliacao
  cota_periodo <- cota_diario %>%
    dplyr::filter(Data > inicio_aval & Data <= fim_aval) %>%
    dplyr::select(all_of(ativos_port_mes))
}
```



      
